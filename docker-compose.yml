name: LumieresLausanne

services:
  db:
    image: mysql:9.3
    env_file: .env
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$$MYSQL_ROOT_PASSWORD"]
      interval: 30s
      timeout: 10s
      retries: 5

  app:
    build:
      context: .
      dockerfile: docker/Dockerfile.app
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      solr:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./app/media:/app/app/media
      - ./logging:/app/logging
    ports:
      - "8000:8000"

  solr:
    image: solr:8
    volumes:
      - ./solr/configsets/lumieres:/var/solr/configsets/lumieres:ro
      - solr_data:/var/solr/data
    command: >
      bash -lc "
        solr-precreate lumieres /var/solr/configsets/lumieres &&
        solr-foreground"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- 'http://localhost:8983/solr/admin/cores?action=STATUS&core=lumieres' | grep -q '\"name\":\"lumieres\"'"]
      interval: 20s
      timeout: 5s
      retries: 10

volumes:
  db_data:
  solr_data: