<script type="text/javascript">
// Firefox detection for CSS fix (issue #105): @-moz-document no longer works
// in author stylesheets, so we detect Firefox via JS and add a class to body.
if (typeof InstallTrigger !== 'undefined' || navigator.userAgent.indexOf('Firefox') !== -1) {
	document.body.classList.add('is-firefox');
}

// Helper function to get current notes position
function getNotesPosition() {
	return document.body.getAttribute('data-notes-position') || 'bottom';
}

function toggleBR() {
	// Check if line breaks are currently hidden by looking at the actual BR elements
	var firstBr = $('div.transcription-data br').not($('div.transcription-data .verse br')).first();
	var areHidden = firstBr.hasClass('hidden-br');
	
	if (areHidden) {
        // Show line breaks
        $('div.transcription-data br').not($('div.transcription-data .verse br')).removeClass('hidden-br');
        $("div.transcription-data .brsep").show();
        // Add class to body for Firefox CSS fix (issue #105)
        $('body').addClass('linebreaks-visible');
	} else {
        // Hide line breaks
        $('div.transcription-data br').not($('div.transcription-data .verse br')).addClass('hidden-br');
        $("div.transcription-data .brsep").hide();
        // Remove class from body for Firefox CSS fix (issue #105)
        $('body').removeClass('linebreaks-visible');
	}
	
	// Recalculate note positions if margin notes are displayed
	if (getNotesPosition() === 'margin' && $('.side-notes-panel').length > 0) {
		setTimeout(repositionSideNotes, 150);
	}
}

function toggleView() {
    if ( $("div.transcription-data").attr('data-mode') == 'dipl') {
        $("#view-toggle > span").text('Passer en version diplomatique');
        $("div.transcription-data").attr('data-mode','norm');
        $('div.transcription-data .overline').each(function () {
        	var this$ = $(this);
        	var textToDouble = this$.text();
        	this$.text(textToDouble + textToDouble);
        });
        $("div.transcription-data").toggleClass('norm');
    } else {
        $("#view-toggle > span").text('Passer en version éditée');
        $("div.transcription-data").attr('data-mode','dipl');
        $('div.transcription-data .overline').each(function () {
        	var this$ = $(this);
        	var doubledText = this$.text();
        	this$.text(doubledText.substring(0, doubledText.length / 2));
        });
        $("div.transcription-data").toggleClass('norm');
    }
    syncSideNotesMode();
    
    // Recalculate note positions if margin notes are displayed
    if (getNotesPosition() === 'margin' && $('.side-notes-panel').length > 0) {
        setTimeout(repositionSideNotes, 150);
    }
}

function toggleTOC() {
    if ( $('#transcription-toc').length > 0 ) {
        $('#transcription-toc, a.tocref').remove();
        $('#toc-toggle > span').text('Montrer la table des matières');
        // Removed padding-right adjustment - TOC is now positioned fixed and doesn't need text adjustment
        // $('.transcription-data').first().css('padding-right', '40px');
    } else {
        $('#toc-toggle > span').text('Cacher la table des matières');

        var trans = $('.transcription-data').first();
        console.log('TOC DEBUG: Found transcription element:', trans.length);
        console.log('TOC DEBUG: Transcription HTML:', trans.html().substring(0, 500));
        
        // Removed padding-right adjustment - TOC is now positioned fixed and doesn't need text adjustment
        // trans.css('padding-right', '240px');
        var toc = $('<ul id="transcription-toc"><div class="title">Table des matières</div></ul>');
        var headers = $('h2, h3', trans);
        console.log('TOC DEBUG: Found headers:', headers.length);
        headers.each(function (i) {
            var header = $(this);
            console.log('TOC DEBUG: Header', i, ':', this.tagName, header.text());
            var level = (this.tagName === 'H2') ? 1 : 2;
            header.prepend('<a name="toc-' + i + '" class="tocref"></a>');
            header = header.clone().find('.sic, del, .brsep').remove().end();
            toc.append('<li class="toclevel' + level + '"><a href="#toc-' + i
                       + '">' + header.text() + '</a></li>');
        });
        console.log('TOC DEBUG: TOC HTML:', toc.html());
        // Append to transcription-viewer-container for proper positioning
        var container = $('.transcription-viewer-container');
        if (container.length > 0) {
            container.append(toc);
        } else {
            // Fallback to body if container not found
            $('body').append(toc);
        }
    }
    
    // Recalculate note positions if margin notes are displayed
    if (getNotesPosition() === 'margin' && $('.side-notes-panel').length > 0) {
        setTimeout(repositionSideNotes, 150);
    }
}

// Initialize notes position preference
function initializeNotesPosition() {
	var layoutMode = document.body.getAttribute('data-layout-mode') || 'split-view';
	var savedPosition = null;
	
	// Only allow saved preference in text-only mode
	if (layoutMode === 'text-only') {
		try {
			savedPosition = sessionStorage.getItem('transcription-notes-position');
		} catch (e) {
			// sessionStorage not available
		}
	}
	
	// Set default based on layout mode if no saved preference
	if (!savedPosition) {
		if (layoutMode === 'text-only') {
			savedPosition = 'margin';
		} else {
			// Always use bottom for split-view and viewer-only
			savedPosition = 'bottom';
		}
	}
	
	// Store the preference
	document.body.setAttribute('data-notes-position', savedPosition);
	updateNotesPositionButton(savedPosition);
}

// Toggle notes position between margin and bottom (only in text-only mode)
function toggleNotesPosition() {
	var layoutMode = document.body.getAttribute('data-layout-mode') || 'split-view';
	
	// Only allow toggle in text-only mode
	if (layoutMode !== 'text-only') {
		return;
	}
	
	var currentPosition = getNotesPosition();
	var newPosition = (currentPosition === 'margin') ? 'bottom' : 'margin';
	
	document.body.setAttribute('data-notes-position', newPosition);
	
	try {
		sessionStorage.setItem('transcription-notes-position', newPosition);
	} catch (e) {
		// Ignore if session storage is not available
	}
	
	updateNotesPositionButton(newPosition);
	processNotes();
}

// Update the notes position button text
function updateNotesPositionButton(position) {
	var $button = $('#notes-position-toggle > span');
	if (position === 'margin') {
		$button.text('Notes en bas de page');
	} else {
		$button.text('Notes en marge');
	}
}

// Keep side notes display mode in sync with the transcription view (dipl/norm)
function syncSideNotesMode() {
	var isNorm = $('.transcription-data').hasClass('norm');
	$('.side-notes-panel').toggleClass('norm', isNorm);
}

$(function() {
	// Hide line breaks by default on page load
	$('div.transcription-data br').not($('div.transcription-data .verse br')).addClass('hidden-br');
	$("div.transcription-data .brsep").hide();
	
	$("#lb-toggle").click(function() { toggleBR(); });
	$("#view-toggle").click(function() { toggleView(); });
	$("#toc-toggle").click(function() { toggleTOC(); });
	$("#notes-position-toggle").click(function() { toggleNotesPosition(); });

	// Hide/show notes position toggle based on layout mode
	function updateNotesToggleVisibility() {
		var layoutMode = document.body.getAttribute('data-layout-mode') || 'split-view';
		var $toggle = $('#notes-position-toggle');
		var shouldShow = layoutMode === 'text-only';
		
		if (shouldShow) {
			$toggle.removeClass('notes-toggle-hidden').removeAttr('hidden').attr('aria-hidden', 'false');
		} else {
			$toggle.addClass('notes-toggle-hidden').attr('hidden', 'hidden').attr('aria-hidden', 'true');
		}
	}
	
	// Initial visibility check - run after a short delay to ensure layout mode is set
	setTimeout(updateNotesToggleVisibility, 100);
	// Also run immediately in case layout mode is already set
	updateNotesToggleVisibility();

	// Initialize notes position preference from session storage
	initializeNotesPosition();

	// Process notes for both side panel and bottom display
	processNotes();
	syncSideNotesMode();

	// Listen for layout mode changes to rebuild notes
	var layoutObserver = new MutationObserver(function(mutations) {
		mutations.forEach(function(mutation) {
			if (mutation.type === 'attributes' && mutation.attributeName === 'data-layout-mode') {
				// Update button visibility
				updateNotesToggleVisibility();
				// Reinitialize notes position based on new layout mode
				initializeNotesPosition();
				processNotes();
				syncSideNotesMode();
			}
		});
	});
	layoutObserver.observe(document.body, { attributes: true });

	// Listen for window resize to reposition side notes
	$(window).on('resize', function() {
		if (getNotesPosition() === 'margin' && $('.side-notes-panel').length > 0) {
			setTimeout(repositionSideNotes, 150);
		}
	});

	$("div.transcription-data").html(function (i, oldHtml) {
		return oldHtml.replace(/=\s*(<br[^>]*>)\s*/g,'<span class="brsep">=</span>$1');
	});

	$(".illeg").after('<span class="illeg-short">[...]</span>');
	$(".sic").each(function() {
		$(this).after('<span class="corr">' + $(this).attr('data-corr') + '</span>');
	});
});

// Process notes based on layout mode and notes position preference
function processNotes() {
	var layoutMode = document.body.getAttribute('data-layout-mode') || 'split-view';
	var useMarginNotes = (layoutMode === 'text-only' && getNotesPosition() === 'margin');
	
	// Clear existing notes
	$('.transcription-doc-notes, .transcription-ed-notes').remove();
	$('.side-notes-panel').remove();
	
	// Unwrap if wrapped
	if ($('#transcription-data').parent().hasClass('transcription-content-wrapper')) {
		$('#transcription-data').unwrap();
	}
	
	// Remove all note-ref-link wrappers and unwrap note markers from any <a> tags
	var trans = $('.transcription-data').first();
	
	// First pass: remove note-ref-link wrappers
	$('.note-ref-link', trans).each(function() {
		$(this).replaceWith($(this).contents());
	});
	
	// Second pass: unwrap any remaining <a> tags around note markers
	// This handles links created by createBottomNotes()
	$('.note-document, .note-editorial', trans).each(function() {
		var $this = $(this);
		// Unwrap from parent <a> tags until we reach a non-<a> parent
		while ($this.parent().is('a')) {
			$this.unwrap();
		}
	});
	
	if (useMarginNotes) {
		// Wrap transcription-data in a flex container for side-by-side layout
		$('#transcription-data').wrap('<div class="transcription-content-wrapper"></div>');
		// Create side notes panel
		createSideNotes();
	} else {
		// Create bottom notes (original behavior)
		createBottomNotes();
	}
	syncSideNotesMode();
}

// Create notes in side panel for text-only mode
function createSideNotes() {
	var trans = $('.transcription-data').first();
	var sidePanel = $('<div class="side-notes-panel"></div>');
	
	var hasDocNotes = $('.note-document', trans).length > 0;
	var hasEdNotes = $('.note-editorial', trans).length > 0;
	
	if (!hasDocNotes && !hasEdNotes) return;
	
	// Hide panel during positioning to prevent flicker
	sidePanel.css('visibility', 'hidden');
	
	// Insert side panel into the wrapper
	var wrapper = $('#transcription-data').parent('.transcription-content-wrapper');
	if (wrapper.length === 0) {
		wrapper = $('#transcription-data').closest('.transcription-content');
	}
	wrapper.append(sidePanel);
	syncSideNotesMode();
	
	// Use requestAnimationFrame for smooth positioning without flicker
	requestAnimationFrame(function() {
		positionSideNotes(sidePanel, trans, hasDocNotes, hasEdNotes);
	});
}

// Function to reposition existing side notes
function repositionSideNotes() {
	var sidePanel = $('.side-notes-panel');
	if (sidePanel.length === 0) return;
	
	requestAnimationFrame(function() {
		// Read phase: collect all position data first
		var sidePanelTop = sidePanel.offset().top;
		var positions = [];
		
		// Collect document note positions
		$('.side-note.note-document', sidePanel).each(function(noteIndex) {
			var noteDiv = $(this);
			var citeId = 'citedocnote-side-' + noteIndex;
			var marker = $('a[name="' + citeId + '"]');
			
			if (marker.length > 0) {
				var markerOffset = marker.offset();
				if (markerOffset) {
					positions.push({
						noteDiv: noteDiv,
						top: Math.max(0, markerOffset.top - sidePanelTop)
					});
				}
			}
		});
		
		// Collect editorial note positions
		$('.side-note.note-editorial', sidePanel).each(function(noteIndex) {
			var noteDiv = $(this);
			var citeId = 'citeednote-side-' + noteIndex;
			var marker = $('a[name="' + citeId + '"]');
			
			if (marker.length > 0) {
				var markerOffset = marker.offset();
				if (markerOffset) {
					positions.push({
						noteDiv: noteDiv,
						top: Math.max(0, markerOffset.top - sidePanelTop)
					});
				}
			}
		});
		
		// Write phase: apply all positions at once
		for (var i = 0; i < positions.length; i++) {
			positions[i].noteDiv.css('top', positions[i].top + 'px');
		}
		
		// Prevent note overlaps and recalculate side panel min-height
		requestAnimationFrame(function() {
			var notes = $('.side-note', sidePanel).toArray().sort(function(a, b) {
				return (parseInt($(a).css('top')) || 0) - (parseInt($(b).css('top')) || 0);
			});
			
			var lastBottom = 0;
			var minGap = 5; // Minimum gap between notes
			
			// Read phase: calculate adjustments
			var adjustments = [];
			for (var j = 0; j < notes.length; j++) {
				var $note = $(notes[j]);
				var currentTop = parseInt($note.css('top')) || 0;
				
				if (currentTop < lastBottom) {
					adjustments.push({ note: $note, top: lastBottom });
					currentTop = lastBottom;
				}
				
				lastBottom = currentTop + $note.outerHeight() + minGap;
			}
			
			// Write phase: apply adjustments
			for (var k = 0; k < adjustments.length; k++) {
				adjustments[k].note.css('top', adjustments[k].top + 'px');
			}
			
			// Set minimum height based on actual note positions
			if (notes.length > 0) {
				sidePanel.css('min-height', lastBottom + 'px');
			}
		});
	});
}

function positionSideNotes(sidePanel, trans, hasDocNotes, hasEdNotes) {
	// Store note data for batched positioning
	var notesToPosition = [];
	
	// Process document notes
	if (hasDocNotes) {
		$('.note-document', trans).each(function(noteIndex) {
			var $this = $(this);
			var noteId = 'docnote-side-' + noteIndex;
			var citeId = 'citedocnote-side-' + noteIndex;
			
			// Wrap the note marker
			if (!$this.parent().hasClass('note-ref-link')) {
				$this.wrap('<a href="#' + noteId + '" name="' + citeId + '" class="note-ref-link" />');
			}
			
			// Create side note
			var noteHtml = $($.parseHTML($this.attr('data-note').replace(/&quot;/igm, '"')
												  .replace(/&gt;/igm, '>').replace(/&lt;/igm, '<')));
			var noteDiv = $('<div class="side-note note-document"></div>');
			noteDiv.append('<span class="note-number">' + toRoman(noteIndex + 1).toLowerCase() + '</span>');
			noteDiv.append('<a href="#' + citeId + '" name="' + noteId + '" class="note-back-link">↑</a> ');
			noteDiv.append(noteHtml);
			
			sidePanel.append(noteDiv);
			
			// Store for batched positioning
			notesToPosition.push({
				noteDiv: noteDiv,
				marker: $this.parent('.note-ref-link')
			});
		});
	}
	
	// Process editorial notes
	if (hasEdNotes) {
		$('.note-editorial', trans).each(function(noteIndex) {
			var $this = $(this);
			var noteId = 'ednote-side-' + noteIndex;
			var citeId = 'citeednote-side-' + noteIndex;
			
			// Wrap the note marker
			if (!$this.parent().hasClass('note-ref-link')) {
				$this.wrap('<a href="#' + noteId + '" name="' + citeId + '" class="note-ref-link" />');
			}
			
			// Create side note
			var noteHtml = $($.parseHTML($this.attr('data-note').replace(/&quot;/igm, '"')
												  .replace(/&gt;/igm, '>').replace(/&lt;/igm, '<')));
			var noteDiv = $('<div class="side-note note-editorial"></div>');
			noteDiv.append('<span class="note-number">' + (noteIndex + 1) + '</span>');
			noteDiv.append('<a href="#' + citeId + '" name="' + noteId + '" class="note-back-link">↑</a> ');
			noteDiv.append(noteHtml);
			
			sidePanel.append(noteDiv);
			
			// Store for batched positioning
			notesToPosition.push({
				noteDiv: noteDiv,
				marker: $this.parent('.note-ref-link')
			});
		});
	}
	
	// Batch position all notes in one operation to prevent flicker
	requestAnimationFrame(function() {
		// Read phase: collect all position data first (avoid layout thrashing)
		var sidePanelTop = sidePanel.offset().top;
		var positions = [];
		
		for (var i = 0; i < notesToPosition.length; i++) {
			var markerOffset = notesToPosition[i].marker.offset();
			if (markerOffset) {
				positions.push({
					noteDiv: notesToPosition[i].noteDiv,
					top: Math.max(0, markerOffset.top - sidePanelTop)
				});
			}
		}
		
		// Write phase: apply all positions at once
		for (var j = 0; j < positions.length; j++) {
			positions[j].noteDiv.css('top', positions[j].top + 'px');
		}
		
		// Prevent note overlaps and ensure proper spacing
		requestAnimationFrame(function() {
			var notes = $('.side-note', sidePanel).toArray().sort(function(a, b) {
				return (parseInt($(a).css('top')) || 0) - (parseInt($(b).css('top')) || 0);
			});
			
			var lastBottom = 0;
			var minGap = 5; // Minimum gap between notes
			
			// Read phase: calculate new positions
			var adjustments = [];
			for (var k = 0; k < notes.length; k++) {
				var $note = $(notes[k]);
				var currentTop = parseInt($note.css('top')) || 0;
				
				if (currentTop < lastBottom) {
					adjustments.push({ note: $note, top: lastBottom });
					currentTop = lastBottom;
				}
				
				lastBottom = currentTop + $note.outerHeight() + minGap;
			}
			
			// Write phase: apply adjustments
			for (var m = 0; m < adjustments.length; m++) {
				adjustments[m].note.css('top', adjustments[m].top + 'px');
			}
			
			// Set minimum height and show panel
			if (notes.length > 0) {
				sidePanel.css('min-height', lastBottom + 'px');
			}
			
			// Make panel visible after all positioning is complete
			sidePanel.css('visibility', 'visible');
		});
	});
}

// Create notes at bottom (original behavior) for split-view and viewer-only modes
function createBottomNotes() {
	$('.transcription-data').each(function (transIndex) {
		var trans = $(this);
		$('.note-document', this).each(function(noteIndex) {
			var $this = $(this);
			if (noteIndex === 0) {
				trans.append('<div class="transcription-doc-notes"><p class="title">Notes du texte</p></div>');
			}
			$this.wrap('<a href="#docnote-' + transIndex + '-' + noteIndex +
					   '" name="citedocnote-' + transIndex + '-' + noteIndex + '" />');
			var html = $($.parseHTML($(this).attr('data-note').replace(/&quot;/igm, '"')
												  .replace(/&gt;/igm, '>').replace(/&lt;/igm, '<')))
				, className = $this.attr('class')
				, noteLink = '<a href="#citedocnote-' + transIndex + '-' + noteIndex
							 + '" name="docnote-' + transIndex + '-' + noteIndex + '">↑</a> ';
			if ( html.first().is('p') ) {
				html.first().prepend(noteLink).addClass(className);
			} else {
				html = $('<div class="' + className + '"/>').append(html.first().before(noteLink));
			}
			$('.transcription-doc-notes', trans).append(html);
		});
	});

	$('.transcription-data').each(function (transIndex) {
		var trans = $(this);
		$('.note-editorial', this).each(function(noteIndex) {
			var $this = $(this);
			if (noteIndex === 0) {
				trans.append('<div class="transcription-ed-notes"><p class="title">Notes de l\'éditeur</p></div>');
			}
			$this.wrap('<a href="#ednote-' + transIndex + '-' + noteIndex
					+ '" name="citeednote-' + transIndex + '-' + noteIndex + '" />');
			var html = $($.parseHTML($(this).attr('data-note').replace(/&quot;/igm, '"')
									 .replace(/&gt;/igm, '>').replace(/&lt;/igm, '<')))
				, className = $(this).attr('class')
				, noteLink = '<a href="#citeednote-' + transIndex + '-' + noteIndex
							 + '" name="ednote-' + transIndex + '-' + noteIndex + '">↑</a> ';
			if ( html.first().is('p') ) {
				html.first().prepend(noteLink).addClass(className);
			} else {
				html = $('<div class="' + className + '"/>').append(html.first().before(noteLink));
			}
			$('.transcription-ed-notes', trans).append(html);
		});
	});
}

// Helper function to convert number to Roman numerals (for document notes)
function toRoman(num) {
	var lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};
	var roman = '';
	for (var i in lookup) {
		while (num >= lookup[i]) {
			roman += i;
			num -= lookup[i];
		}
	}
	return roman;
}

// Make toggle functions globally accessible for options menu
window.toggleBR = toggleBR;
window.toggleView = toggleView;
window.toggleTOC = toggleTOC;
window.toggleNotesPosition = toggleNotesPosition;
</script>

<div id="transcription-data" class="transcription-data cked-content" data-mode="norm">
	{{ trans|safe }}
</div>
