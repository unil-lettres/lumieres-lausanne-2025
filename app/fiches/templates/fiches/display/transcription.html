{% extends ext_template %}
{% comment %}<!--
   Copyright (C) 2010-2012 Université de Lausanne, RISET
   < http://www.unil.ch/riset/ >

   This file is part of Lumières.Lausanne.
   Lumières.Lausanne is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   Lumières.Lausanne is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

   This copyright notice MUST APPEAR in all copies of the file.
-->{% endcomment %}
{% load i18n %}
{% load fiches_extras %}
{% load static %}

{% block page_title %}{{ trans.manuscript_b.title|truncatewords:6|slice:"65"}}{{ block.super }}{% endblock page_title %}
{% block main_menu %}{% with "trans" as fiche_type %}{{ block.super }}{% endwith %}{% endblock %}


{% block head_css %}
	{{ block.super }}
	<link rel="stylesheet" href="{% static 'css/tinyMCE_transcripts.css' %}" media="all" charset="utf-8" />
	<link rel="stylesheet" href="{% static 'fiches/css/viewer-controls.css' %}" />
	<style>
		/* Two-column layout: transcription on left, viewer on right */
		.transcription-viewer-container {
			display: flex;
			gap: 20px;
			width: 100%;
			position: relative;
			z-index: 1;
		}
		
		.transcription-content {
			flex: 1;
			min-width: 0; /* Allow flex item to shrink below content size */
			display: flex;
			flex-direction: column;
		}

		.transcription-content #transcription-view-controls {
			margin-bottom: 12px;
		}

		.transcription-content #transcription-data {
			flex: 1;
			max-height: 600px;
			overflow-y: auto;
			overflow-x: hidden;
		}
		
		.viewer-panel {
			width: 450px;
			flex-shrink: 0;
			position: sticky;
			top: 20px;
			height: fit-content;
			max-height: calc(100vh - 40px);
			z-index: 10;
		}
		
		#openseadragon-viewer {
			width: 100%;
			height: 600px;
			background-color: #000;
			border: 1px solid #ccc;
		}
		
		.content .transcription-data {
			padding: 0 20px;
		}
		
		/* Table of contents styling */
		#transcription-toc {
			position: static !important;
			float: none !important;
			width: 100% !important;
			background: #f5f5f0;
			padding: 10px 15px;
			margin: 0 0 15px 0;
			border-bottom: 2px solid #c4c5b4;
			max-height: 75px;
			overflow-y: auto;
			font-size: 11px;
			box-shadow: none !important;
			top: auto !important;
			right: auto !important;
		}
		
		#transcription-toc .title {
			font-weight: bold;
			margin-bottom: 5px;
		}
		
		#transcription-toc ul {
			margin: 0;
			padding: 0;
		}
		
		#transcription-toc li {
			list-style: disc inside;
		}
		
		#transcription-toc .toclevel2 {
			padding-left: 10px;
		}
		
		/* Prevent cite_as from overlapping viewer */
		.field_group.cite_as {
			position: static !important;
			margin-top: 20px;
		}
		
		/* Single column when no viewer - handled by removing flex when no viewer panel */
		
		/* Responsive: stack on smaller screens */
		@media (max-width: 1200px) {
			.transcription-viewer-container {
				flex-direction: column;
			}
			
			.viewer-panel {
				width: 100%;
				position: static;
				max-height: none;
			}

			.transcription-content #transcription-data {
				max-height: none;
			}
		}
		
		/* Layout mode styles */
		.layout-toggle-group {
			display: flex;
			gap: 8px;
			margin-bottom: 10px;
			justify-content: center;
		}
		
		.layout-btn {
			padding: 8px 16px;
			background: #fff;
			border: 1px solid #ced4da;
			border-radius: 4px;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.2s ease;
			color: #212529;
		}
		
		.layout-btn:hover {
			background: #e9ecef;
			border-color: #adb5bd;
		}
		
		.layout-btn.active {
			background: #ff8c00;
			color: #fff;
			border-color: #ff8c00;
		}
		
		.layout-btn.active:hover {
			background: #e67e00;
			border-color: #cc7000;
		}
		
		/* Text-only mode */
		body[data-layout-mode="text-only"] .viewer-panel {
			display: none;
		}
		
		body[data-layout-mode="text-only"] .transcription-content {
			max-width: 100%;
		}
		
		body[data-layout-mode="text-only"] .transcription-viewer-container {
			display: block;
		}
		
		body[data-layout-mode="text-only"] .transcription-content #transcription-data {
			max-height: none;
		}
		
		/* Viewer-only mode */
		body[data-layout-mode="viewer-only"] .transcription-content {
			display: none;
		}
		
		body[data-layout-mode="viewer-only"] .transcription-viewer-container {
			justify-content: center;
		}
		
		body[data-layout-mode="viewer-only"] .viewer-panel {
			position: static;
			width: 800px;
			max-width: 90%;
		}
		
		body[data-layout-mode="viewer-only"] #openseadragon-viewer {
			height: 800px;
		}
	</style>
{% endblock head_css %}

{% if trans_user_access %}
{% block head_js %}
	{% url 'transcription-delete' trans.id as delete_url %}
	{{ block.super }}

<!-- jQuery UI CSS (if not loaded in base) -->
<link rel="stylesheet" href="{% static 'js/lib/jquery-ui-1.9/css/smoothness/jquery-ui-1.9.custom.css' %}" />

<!-- jQuery UI JS with the "button" widget -->
<script src="{% static 'js/lib/jquery-ui-1.9/js/jquery-ui-1.9.min.js' %}"></script>

<!-- OpenSeadragon -->
<script src="{% static 'js/lib/openseadragon/openseadragon.min.js' %}"></script>
<!-- Viewer Controls -->
<script src="{% static 'fiches/js/viewer-controls.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/highlighter.js' %}"></script>
	<script type="text/javascript">
		{% if user.is_authenticated and display_collector %}
		//{# ---------- Collection Mamagement ---------- #}
		function add_obj2col(){
			collector.addObj_open({
				item_title: 'Fiche bibliographique: {{ trans.manuscript_b.title|truncate_chars:"64" }} ',
				item_id: '{{ trans.manuscript_b.id }}',
				item_type: 'Biblio'
			});
		}
		{% endif %}
		
		//{# ---------- OpenSeadragon Viewer ---------- #}
		(function() {
			// Initialize OpenSeadragon viewer when DOM is ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initializeViewer);
			} else {
				initializeViewer();
			}
			
			function initializeViewer() {
				// Get IIIF URL from the transcription model
				var iiifUrl = "{{ trans.facsimile_iiif_url|escapejs }}";
				
				if (iiifUrl && iiifUrl.trim()) {
					// Check if it's a manifest URL or direct image info.json
					if (iiifUrl.includes('manifest')) {
						// Fetch the manifest and extract images using Fetch API
						fetch(iiifUrl)
							.then(function(response) {
								if (!response.ok) {
									throw new Error('HTTP error! status: ' + response.status);
								}
								return response.json();
							})
							.then(function(manifest) {
								console.log('[IIIF] Loaded manifest:', manifest);
								var tileSources = [];
								
								// IIIF Presentation API v3 (items)
								if (manifest.items && manifest.items.length > 0) {
									console.log('[IIIF] Processing v3 manifest with', manifest.items.length, 'canvases');
									manifest.items.forEach(function(canvas) {
										if (canvas.items && canvas.items[0] && canvas.items[0].items) {
											var annotation = canvas.items[0].items[0];
											if (annotation.body) {
												var body = annotation.body;
												// Get service URL from service array
												if (body.service && body.service.length > 0) {
													var serviceId = body.service[0]['@id'] || body.service[0].id;
													if (serviceId) {
														tileSources.push(serviceId + '/info.json');
														console.log('[IIIF] Added tile source:', serviceId + '/info.json');
													}
												}
											}
										}
									});
								}
								// IIIF Presentation API v2 (sequences)
								else if (manifest.sequences && manifest.sequences[0]) {
									var canvases = manifest.sequences[0].canvases || [];
									console.log('[IIIF] Processing v2 manifest with', canvases.length, 'canvases');
									canvases.forEach(function(canvas) {
										if (canvas.images && canvas.images[0]) {
											var resource = canvas.images[0].resource;
											if (resource.service) {
												var serviceId = resource.service['@id'] || resource.service.id;
												if (serviceId) {
													tileSources.push(serviceId + '/info.json');
													console.log('[IIIF] Added tile source:', serviceId + '/info.json');
												}
											}
										}
									});
								}
								
								console.log('[IIIF] Total tile sources extracted:', tileSources.length);
								if (tileSources.length > 0) {
									initViewer(tileSources);
								} else {
									console.error('Could not extract image URLs from manifest');
									showError('Erreur: Impossible d\'extraire les images du manifeste IIIF');
								}
							})
							.catch(function(error) {
								console.error('Failed to load manifest:', error);
								showError('Erreur: Impossible de charger le manifeste IIIF<br><small>' + error.message + '</small>');
							});
					} else {
						// Direct image info.json URL
						initViewer([iiifUrl]);
					}
				}
			}
			
			function showError(message) {
				var viewerDiv = document.getElementById('openseadragon-viewer');
				if (viewerDiv) {
					viewerDiv.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">' + message + '</div>';
				}
			}
			
			function initViewer(tileSources) {
				var viewer = OpenSeadragon({
					id: "openseadragon-viewer",
					prefixUrl: "{% static 'js/lib/openseadragon/images/' %}",
					tileSources: tileSources,
					sequenceMode: true, // Always enable sequence mode
					initialPage: 0,
					preserveViewport: false,
					preserveImageSizeOnResize: true,
					visibilityRatio: 0.5,
					showNavigationControl: false, // Disable default controls
					showZoomControl: false,
					showHomeControl: false,
					showFullPageControl: false,
					showSequenceControl: false,
					showNavigator: tileSources.length > 1,
					navigatorPosition: "TOP_RIGHT",
					navigatorHeight: "120px",
					navigatorWidth: "150px",
					showReferenceStrip: tileSources.length > 1,
					referenceStripScroll: 'horizontal'
				});
				
				// Initialize custom controls after viewer is ready
				viewer.addHandler('open', function() {
					window.initViewerControls(viewer);
					
					// Initialize page synchronization after viewer is ready
					initPageSync(viewer);
				});
			}
		})();
		
		//{# ---------- Page Synchronization ---------- #}
		function initPageSync(viewer) {
			var transcriptionBox = document.getElementById('transcription-data');
			if (!transcriptionBox || !viewer) return;
			
			console.log('[Page Sync] Initializing page synchronization...');
			
			// Find all page tags in two formats:
			// 1. /p. <number>/
			// 2. <number>r or <number>v (recto/verso) - may be HTML encoded as &lt;1v&gt;
			var pageTagRegex1 = /\/p\.\s*(\d+)\//g;
			var pageTagRegex2 = /(?:<|&lt;)(\d+)([rv])(?:>|&gt;)/gi;
			var transcriptionHTML = transcriptionBox.innerHTML;
			var pageTags = [];
			var match;
			
			// Extract page numbers from /p. N/ format
			while ((match = pageTagRegex1.exec(transcriptionHTML)) !== null) {
				pageTags.push({
					pageNumber: parseInt(match[1], 10),
					pattern: match[0],
					type: 'p-format'
				});
			}
			
			// Extract page numbers from <Nr> or <Nv> format
			// Reset regex lastIndex
			pageTagRegex2.lastIndex = 0;
			while ((match = pageTagRegex2.exec(transcriptionHTML)) !== null) {
				var pageNum = parseInt(match[1], 10);
				var side = match[2]; // 'r' or 'v'
				// Calculate page index: recto = odd pages (1r=page1, 2r=page3), verso = even pages (1v=page2, 2v=page4)
				var calculatedPage = side === 'r' ? (pageNum * 2 - 1) : (pageNum * 2);
				
				pageTags.push({
					pageNumber: calculatedPage,
					pattern: match[0],
					originalPage: pageNum,
					side: side,
					type: 'rv-format'
				});
			}
			
			// Sort page tags by their appearance in the HTML
			pageTags.sort(function(a, b) {
				return transcriptionHTML.indexOf(a.pattern) - transcriptionHTML.indexOf(b.pattern);
			});
			
			console.log('[Page Sync] Found', pageTags.length, 'page tags:', pageTags.map(function(t) { 
				return t.type === 'rv-format' ? t.originalPage + t.side + '(p.' + t.pageNumber + ')' : 'p.' + t.pageNumber; 
			}).join(', '));
			
			if (pageTags.length === 0) {
				console.log('[Page Sync] No page tags found in transcription');
				return;
			}
			
			// Wrap page tags with identifiable spans for position tracking
			pageTags.forEach(function(tag, index) {
				var wrappedTag = '<span class="page-tag" data-page="' + tag.pageNumber + '" id="page-tag-' + index + '" data-type="' + tag.type + '">' + tag.pattern + '</span>';
				transcriptionHTML = transcriptionHTML.replace(tag.pattern, wrappedTag);
				console.log('[Page Sync] Wrapped page tag:', tag.pattern, '→ page-tag-' + index, '(viewer page ' + tag.pageNumber + ')');
			});
			transcriptionBox.innerHTML = transcriptionHTML;
			console.log('[Page Sync] All page tags wrapped and ready for tracking');
			
			var lastSyncedPage = null;
			var isUserScrolling = true;
			
			console.log('[Page Sync] Setting up scroll listener on:', transcriptionBox);
			
			// Scroll handler to detect which page tag is at the top
			function syncViewerToScroll() {
				console.log('[Page Sync] Scroll event triggered, isUserScrolling:', isUserScrolling);
				
				if (!isUserScrolling) return;
				
				var containerRect = transcriptionBox.getBoundingClientRect();
				var containerTop = containerRect.top + 50; // Add small offset for better UX
				
				var visiblePageTag = null;
				var pageTagElements = transcriptionBox.querySelectorAll('.page-tag');
				
				// Find the page tag closest to the top of the container
				pageTagElements.forEach(function(element) {
					var rect = element.getBoundingClientRect();
					console.log('[Page Sync] Checking page tag:', element.getAttribute('data-page'), 'top:', rect.top, 'containerTop:', containerTop);
					if (rect.top <= containerTop && rect.top >= containerRect.top - 100) {
						visiblePageTag = element;
						console.log('[Page Sync] Selected as visible:', element.getAttribute('data-page'));
					}
				});
				
				if (visiblePageTag) {
					var pageNumber = parseInt(visiblePageTag.getAttribute('data-page'), 10);
					var viewerPageIndex = pageNumber - 1; // OpenSeadragon uses 0-based indexing
					
					console.log('[Page Sync] Detected page tag:', pageNumber, '→ viewer index:', viewerPageIndex);
					console.log('[Page Sync] Viewer state:', 'viewer exists:', !!viewer, 'world exists:', !!(viewer && viewer.world), 'itemCount:', viewer && viewer.world ? viewer.world.getItemCount() : 'N/A');
					console.log('[Page Sync] lastSyncedPage:', lastSyncedPage, 'new index:', viewerPageIndex);
					
					if (viewer && viewer.world && viewerPageIndex >= 0 && viewerPageIndex < viewer.world.getItemCount()) {
						if (lastSyncedPage !== viewerPageIndex) {
							console.log('[Page Sync] ✓ Switching viewer from page', lastSyncedPage, 'to page', viewerPageIndex);
							viewer.goToPage(viewerPageIndex);
							lastSyncedPage = viewerPageIndex;
						} else {
							console.log('[Page Sync] ⊗ Already on page', viewerPageIndex, '- skipping');
						}
					} else {
						console.error('[Page Sync] ✗ Cannot switch page. Checks:', {
							viewerExists: !!viewer,
							worldExists: !!(viewer && viewer.world),
							indexValid: viewerPageIndex >= 0,
							indexInRange: viewer && viewer.world ? viewerPageIndex < viewer.world.getItemCount() : false,
							itemCount: viewer && viewer.world ? viewer.world.getItemCount() : 'N/A'
						});
					}
				}
			}
			
			// Debounced scroll handler
			var scrollTimeout;
			transcriptionBox.addEventListener('scroll', function() {
				clearTimeout(scrollTimeout);
				scrollTimeout = setTimeout(syncViewerToScroll, 150);
			});
			
			// Initial sync
			setTimeout(syncViewerToScroll, 500);
		}
		
		//{# keep the cite as box at the bottom of the window #}
		$(function () {
			var scrollCiteAs = function scrollCiteAs() {
				var content = $('div.content');
				var citeAs = $('div.cite_as');
				var w = $(window);
				var coffset = content.offset();
				var cheight = content.height();
				var wtop = w.scrollTop();
				var wheight = w.height();
				if ( coffset.top + cheight - wtop < wheight ) {
					citeAs.offset({ top: coffset.top + cheight + 10 - citeAs.outerHeight(),
					 				left: citeAs.offset().left });
				} else {
					citeAs.offset({ top: wtop + wheight - citeAs.outerHeight(),
								 	left: citeAs.offset().left });
				}
			};
			setTimeout(scrollCiteAs, 0); // a direct call doesn't work on FF
			$(document).scroll(scrollCiteAs);
		});
		
		//{# ---------- Layout Mode Toggle ---------- #}
		$(function() {
			var hasViewer = {{ trans.facsimile_iiif_url|yesno:"1,0" }};
			var storageKey = 'transcription-layout-mode';
			
			if (!hasViewer) {
				document.body.setAttribute('data-layout-mode', 'text-only');
				sessionStorage.removeItem(storageKey);
				return;
			}
			
			var defaultLayout = 'split-view';
			var savedLayout = sessionStorage.getItem(storageKey);
			var initialLayout = savedLayout ? savedLayout : defaultLayout;
			document.body.setAttribute('data-layout-mode', initialLayout);
			
			$('.layout-btn').removeClass('active');
			$('.layout-btn[data-layout="' + initialLayout + '"]').addClass('active');
			
			// Handle layout button clicks
			$('.layout-btn').on('click', function() {
				var newLayout = $(this).attr('data-layout');
				
				$('.layout-btn').removeClass('active');
				$(this).addClass('active');
				document.body.setAttribute('data-layout-mode', newLayout);
				sessionStorage.setItem(storageKey, newLayout);
			});
		});
	</script>
{% endblock %}
{% endif %}

{#<!-- ========== Fiche Header ========== -->#}
{% block main_header_title %}Transcription{% endblock %}
{% block main_header_toolbar_buttons %}
	<div class="tb_but tb_but_text"><a href="{% url 'display-bibliography' trans.manuscript_b.id %}" title="Aller à la fiche bibliographique"><img src="{% static 'css/images/doctype_manuscript.png' %}" width="16" height="16" /><span>Fiche bibliographique</span></a></div>
    <div class="tb_sep"></div>
	{% if user.is_authenticated and display_collector %}
	<div class="tb_but collection-add-obj"><a href="#" title="{% trans "Ajouter à la collection" %}"><img src="{% static 'css/images/tag_yellow.png' %}" width="16" height="16" alt="{% trans "Ajouter à la collection" %}" /></a></div>
	<div class="tb_sep"></div>
	{% endif %}
	{% if trans_user_access %}
	{% if perms.fiches.change_any_transcription or trans.access_owner == user and perms.fiches.change_transcription %}
		{% url 'transcription-edit' trans.id as edit_url %}
	{% endif %}
	{% if perms.fiches.delete_any_transcription or trans.access_owner == user and perms.fiches.delete_transcription %}
		{% url 'transcription-delete' trans.id as delete_url %}
	{% endif %}
	{% endif %}
	{{ block.super }}
{% endblock %}



{#<!-- ========== Fiche Content ========== -->#}
{% block main_content %}
	{{ block.super }}
	{% if not trans_user_access %}
        <p class="info info-noaccess">Vous ne pouvez pas accéder à cette transcription</p>
	{% else %}
	
		{#<!-- Layout mode toggle buttons -->#}
		{% if trans.facsimile_iiif_url %}
		<div id="layout-toggle-buttons" class="layout-toggle-group">
			<button type="button" class="layout-btn" data-layout="text-only" title="Texte uniquement">
				Texte
			</button>
			<button type="button" class="layout-btn active" data-layout="split-view" title="Texte et facsimilé">
				Texte + Facsimilé
			</button>
			<button type="button" class="layout-btn" data-layout="viewer-only" title="Facsimilé uniquement">
				Facsimilé
			</button>
		</div>
		{% endif %}

        <h2 class="transcription">{% include "fiches/bibliography_references/biblio_template.html" with ref=trans.manuscript_b nolink=1 %}</h2>
		
		{#<!-- Transcription text with viewer on the right -->#}
		<div class="transcription-viewer-container">
			<div class="transcription-content">
				{% include "fiches/display/transcription_field.html" with trans=trans.text %}
			</div>
			
			<!-- Right column: OpenSeadragon Viewer (only if IIIF URL exists) -->
			{% if trans.facsimile_iiif_url %}
			<div class="viewer-panel">
				{% include "fiches/includes/viewer_controls.html" %}
				<div id="openseadragon-viewer"></div>
			</div>
			{% endif %}
		</div>
		
		{#<!-- Envelope section -->#}
		{% if trans.envelope %}
		<br/>
		<div class="field_label">Enveloppe</div>
		<div class="transcription-data cked-content" data-mode="dipl" style="margin-top: 2px;">
			{{ trans.envelope|safe }}
		</div>
		<br/>
		{% endif %}

		<div style="border-top:solid 1px black; margin-top: 2em;"></div>

	    {#<!--  Notes  -->#}
	    <div class="field_group meta_notes">
	        {% for note in note_qs %}
	        {% if note|access_lazy:user %}
	        <div class="field_wrap {% if note.access_public %}public_note{% else %}nonpublic_note{% endif %}">
	            <div class="field_label">
	            	Note<br/><br/>
					{% with access_public=note.access_public access_groups=note.access_groups.all %}{% include "fiches/edition/access_status.html" %}{% endwith %}
				</div>
	            <div class="field_value">{{ note.text|safe }}</div>
	            <div class="fixclear"></div>
	        </div>
	        {% endif %}
	        {% endfor %}
	    </div>

		<div class="field_group meta_general" style="margin-bottom: 0 !important;">
			{% if user.is_authenticated %}
			<div class="field_wrap">
				<div class="field_label">Transcrit par</div>
				<div class="field_value">{{ trans.author.get_full_name|default:trans.author.username }}
					{% if trans.author2 %}
					et {{ trans.author2.get_full_name|default:trans.author2 }}
					{% endif %}
				</div>

				<div class="field_label">{{ trans|field_verbose_name:"status" }}</div>
				<div class="field_value">{{ trans.get_status_display|lower }}</div>

				<div class="field_label">Dernière modification</div>
				<div class="field_value last">{{ last_activity.date|date:"d M. Y - H:i" }} ({{ last_activity.user.username }})</div>

				<div class="fixclear"></div>
			</div>
			{% endif %}
			<div class="field_wrap">
				{% if user.is_authenticated and trans.reviewers %}
				<div class="field_label">Relu par</div>
				<div class="field_value">
					{% for r in trans.reviewers.all %}
						{{ r.get_full_name|default:r.username }}{% if not forloop.last %}, {% endif %}
					{% endfor %}
				</div>
				{% endif %}
			
				<div class="field_label">Etendue</div>
				<div class="field_value">{{ trans.get_scope_display|lower }}</div>
			
				{% if user.is_authenticated %}
				<div class="field_label">Accès:</div>
				<div class="field_value last">
					{% with access_public=trans.access_public access_groups=trans.access_groups.all access_private=trans.access_private %}
						{% include "fiches/edition/access_status.html" %}
					{% endwith %}
				</div>
				{% endif %}
				<div class="fixclear"></div>
			</div>
			
		</div>

	    <div class="field_group cite_as" style="margin-bottom: 0 !important;">
	    	<div style="border-top: solid 1px black; padding-top: 10px; margin-top: 5px;">
	        <div class="field_wrap">
	            <div class="field_label">Citer comme</div>
	            <div class="field_value">
					{% spaceless %}
	            	{% with trans.manuscript_b as ref %}
		            	{% for c in ref.get_authors_contributions %}
		            		{% if not forloop.first %} et{% endif %}
		            		{% if c.in_brackets %}[{% endif %}{{ c.person.name }}{% if c.in_brackets %}]{% endif %}{% empty %}[nom de l'auteur]{% endfor %},

						{% if ref.book_title %}
				        &laquo;&nbsp;{{ ref.short_title|default:ref.title }}&nbsp;&raquo;, in <em>{{ ref.book_title }}</em>,
						{% else %}
						<em>{{ ref.short_title|default:ref.title }}</em>,
						{% endif %}

						<span>{{ ref.place|default:"[s.l.]" }}, </span>
				        <span>{{ ref|date_biblio:"date" }}{% if ref.date2 %}-{{ ref|date_biblio:"date2" }}{% endif %}</span>
			        	{% if ref.book_title and ref.volume %}<span>, vol.&nbsp;{{ ref.volume }}</span>{% endif %}
						{% if ref.book_title and ref.pages %}<span>, p.&nbsp;{{ ref.pages }}</span>{% endif %}
						{% if ref.cote %}<span>, cote&nbsp;{{ ref.cote }}</span>
						{% else %}<span>, {{ ref.depot }}</span>{% endif %}
						<span>.</span>
					{% endwith %}
	            	Selon la transcription établie par {{ trans.cite_authors }}Lumières.Lausanne (Université de Lausanne),
	            	url:&nbsp;<a href="{% url 'transcription-display' trans.id %}">
	            	{% if request.is_secure %}
	            	<span>https://</span>
	            	{% else %}
	            	<span>http://</span>
	            	{% endif %}<span>{{ request.get_host }}{% url 'transcription-display' trans.id %}</span></a>,
	            	version du {{ last_activity.date|date:"d.m.Y" }}.

					{% endspaceless %}
	            </div>
	            <div class="fixclear"></div>
	        </div>
					<div class="printing_comments" style="font-style: italic; padding-top: 10px; text-align: center;">Remarque: nous vous recommandons pour
						l'impression d'utiliser le navigateur Safari.</div>
	        </div>
	    </div>


	{% endif %}
{% endblock main_content %}
