{% extends ext_template %}
{% comment %}<!--
   Copyright (C) 2010-2012 Université de Lausanne, RISET
   < http://www.unil.ch/riset/ >

   This file is part of Lumières.Lausanne.
   Lumières.Lausanne is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   Lumières.Lausanne is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

   This copyright notice MUST APPEAR in all copies of the file.
-->{% endcomment %}
{% load fiches_extras i18n static %}

{% block page_title %}{{ transcription.manuscript_b.title|truncatewords:6|slice:"65"}}{{ block.super }}{% endblock page_title %}

{% block head %}
	{{ block.super }}
	{{ transForm.media }}
{% endblock head %}

{% block head_js %}
	{{ block.super }}
	<!-- OpenSeadragon -->
	<script src="{% static 'js/lib/openseadragon/openseadragon.min.js' %}"></script>
{% endblock head_js %}

{% block head_css %}
	{{ block.super }}
	<style type="text/css">
		form.transcription .text textarea { height: 670px; width: 800px; }
		
		form.transcription .radio_field .label { float: left; width: 110px; overflow: hidden; }
		form.transcription .radio_field ul { margin-left: 115px; height: 1.4em; }
		form.transcription .radio_field li { float: left; width: 110px; }
		
		form.transcription .radio_field li label, 
		form.transcription label.inner-label { background-color: #fff; color: #000; font-weight: normal; margin:0; padding: 0;}
		
		form.transcription .trans-text-container { margin-top: 3px; }
/*		form.transcription fieldset.access { border-left: 0; } */
		form.transcription .author_name { font-size: 120%; }

		/* Facsimile viewer styles */
		.transcription-edit-container {
			display: flex;
			gap: 20px;
			align-items: flex-start;
		}
		
		.transcription-edit-content {
			flex: 1;
		}
		
		.facsimile-viewer-panel {
			flex-shrink: 0;
			width: 400px;
			position: sticky;
			top: 20px;
		}
		
		#facsimile-viewer {
			width: 100%;
			height: 500px;
			background-color: #000;
			border: 1px solid #ccc;
		}
		
		.facsimile-controls {
			margin-bottom: 10px;
			padding: 10px;
			background: #f5f5f5;
			border: 1px solid #ddd;
		}
		
		.facsimile-controls h3 {
			margin: 0 0 10px 0;
			font-size: 14px;
			font-weight: bold;
		}
		
		.facsimile-controls button {
			margin-right: 5px;
			padding: 5px 10px;
			cursor: pointer;
		}
		
		/* Hide viewer initially */
		.facsimile-viewer-panel {
			display: none;
		}
		
		.facsimile-viewer-panel.visible {
			display: block;
		}
	</style>
{% endblock head_css %}

{% block main_header_title %}Modification de la transcription{% endblock %}


{% block but_cancel_onclick %}{% spaceless %}
{% if new_object %}{% url 'display-bibliography' transcription.manuscript_b.id as cancel_url %}
{% else %}{% url 'transcription-display' transcription.id as cancel_url %}
{% endif %}
return fiches_edit.cancelEdition('{{ cancel_url }}');
{% endspaceless %}{% endblock %}


{% block main_content %}
{% if new_object %}{% url 'display-bibliography' transcription.manuscript_b.id as cancel_url %}
{% else %}{% url 'transcription-display' transcription.id as cancel_url %}
{% endif %}

{% comment %}<!-- Contournement pour changer le nom des widgets CKEDITOR sans trop se casser la nenette. Pas très joli.
<script type="text/javascript">
	CKEDITOR.on('instanceReady', function(e){
		try {
			jQuery(e.editor.container.$).find(".cke_format .cke_label").text("Styles");
			jQuery(e.editor.container.$).find(".cke_styles .cke_label").text("Format");
		} catch(e) {}
	});
</script>
-->{% endcomment %}

{% if savedPosition %}
<script type="text/javascript">
	CKEDITOR.on('instanceReady', function(e){
		if ( e.editor.name != 'id_text' ) { return; }
		var selection = e.editor.getSelection()
			, editorDoc = selection.getStartElement().$.ownerDocument
			, range 	= new CKEDITOR.dom.range(editorDoc)
			, offset
			, node
			, nodeCk;
		pos = "{{ savedPosition }}".split(",");
		offset = pos.pop();
		node = editorDoc;
		while ( pos.length > 0 ) {
			node = node.childNodes[pos.shift()];
		}
		nodeCk = new CKEDITOR.dom.node(node);
		range.setStart(nodeCk, offset);
		e.editor.focus();
		selection.selectRanges([range]);
		selection.scrollIntoView();
	});
</script>
{% endif %}

<h2>{{ transcription.manuscript_b.title }}</h2>

<div class="transcription-edit-container">
	<div class="transcription-edit-content">
		<form method="post" action="" class="edit-form transcription">{% csrf_token %}
		    <input type="hidden" name="__continue" value="on" />

	{{ transForm.manuscript }}
	{{ transForm.manuscript_b }}
	
	{#<!-- ========== TEXT ========== -->#}
	<fieldset class="no-border">
		<div class="fieldWrapper facsimile_iiif_url">
		    <div>{{ transForm.facsimile_iiif_url.errors }}</div>
		    <label for="id_facsimile_iiif_url">{{ transForm.facsimile_iiif_url.label }}{% tooltiplink "ctxt-help-facsimile-iiif-url" %}</label>
		    {{ transForm.facsimile_iiif_url }}
		    <button type="button" id="validate-facsimile-url" style="margin-left: 10px;">Charger</button>
			<div id="ctxt-help-facsimile-iiif-url" style="display:none">
				<h6>Facsimile IIIF URL</h6>
				<p>URL of the IIIF manifest</p>
			</div>
		</div>
		<div class="fixclear"></div>
		<div class="fieldWrapper text">
		    <div>{{ transForm.text.errors }}
		    {#{{ transForm.text.label_tag }}#}</div>
			<div class="fixclear"></div>
			<div class="trans-text-container">{{ transForm.text }}</div>
		</div>
	</fieldset>

	{#<!-- ========== ENVELOPE ========== -->#}
	<fieldset class="collapsible{% if not transcription.envelope %} collapsed{% endif %}">
		<span class="ui-state-default collapse_btn"></span>
		<div class="legend">Enveloppe</div>
		<div class="fieldWrapper envelope">
		    <div>{{ transForm.envelope.errors }}</div>
			<div class="fixclear"></div>
			<div class="trans-text-container">{{ transForm.envelope }}</div>
		</div>
	</fieldset>
	
	{#<!-- ========== AUTHOR ========== -->#}
	<fieldset>
		<div class="fieldWrapper author">
			<label>Transcrit par</label>
		{% if perms.fiches.change_transcription_ownership %}
			<div style="margin-left: 165px;">
				{{ transForm.author }} {{ transForm.cite_author }}<label for="id_cite_author">Citer cet auteur</label><br/>
				{{ transForm.author2 }} {{ transForm.cite_author2 }}<label for="id_cite_author2">Citer cet auteur</label>
			</div>
		{% else %}
			<span class="author_name">{{ transcription.author.get_full_name|default:transcription.author }}
			{% if transcription.author2 %}
			<br/>
			{{ transcription.author2.get_full_name|default:transcription.author2 }}
			{% endif %}
			</span>
		{% endif %}
		</div>
		<div class="fixclear"></div>
		
		{# ============= REVIEWERS ============= #}
        <div class="fieldWrapper reviewers">
            <label for="id_reviewers">Relu par{% tooltiplink "ctxt-help-transcription-reviewers" %}</label>
            {{ transForm.reviewers }}
			<div id="ctxt-help-transcription-reviewers" style="display:none">
				<h6>Relecteurs</h6>
				<p>Maintenez appuyé &laquo;&nbsp;Ctrl&nbsp;&raquo;, ou &laquo;&nbsp;Commande (touche 
					pomme)&nbsp;&raquo; sur un Mac, pour en sélectionner plusieurs ou en désélectionner.</p>
			</div>
        </div>
        <div class="fixclear"></div>
        
		<div class="fieldWrapper">
			<label>Dernière modification</label>
			{{ last_activity.date|date:"d M. Y - H:i" }}
		</div>
		<div class="fixclear"></div>
	<!--/fieldset-->

	
	{#<!-- ========== STATUS ========== -->#}
	<!--fieldset-->
		<div class="fieldWrapper status radio_field">
			<label>Etat</label>
		    {{ transForm.status.errors }}
			{{ transForm.status }}
		</div>
		<div class="fixclear"></div>

		<div class="fieldWrapper scope radio_field">
			<label>Transcription</label>
		    {{ transForm.scope.errors }}
			{{ transForm.scope }}
		</div>
		<div class="fixclear"></div>		

		{% comment %}
		<!--
		<div class="fieldWrapper status">
		    {{ transForm.status.errors }}
		    <div class="label">{{ transForm.status.label_tag }}: </div>{{ transForm.status }}
		</div>
		<div class="fixclear"></div>
		
		<div class="fieldWrapper scope">
		    {{ transForm.scope.errors }}
		    <div class="label">{{ transForm.scope.label_tag }}: </div>{{ transForm.scope }}
		</div>
		<div class="fixclear"></div>
		-->
		{% endcomment %}
	</fieldset>

    
    {#<!-- ========== ACCES ========== -->#}
    <fieldset class="access">
    	<div class="legend">Type d'Accès</div>
		
        <div class="fieldWrapper access_private radio_field">
            {{ transForm.access_private.errors }}
            <label for="id_access_private">Accès Privé{% tooltiplink "ctxt-help-transcription-access_private" %}</label>
            {{ transForm.access_private }}
			<div id="ctxt-help-transcription-access_private" style="display:none">
				<h6>Accès privé</h6>
				<p>Seul le propriétaire pourra voir cette transcription.</p>
			</div>
        </div>
        <div class="fixclear"></div>
        
        <div class="fieldWrapper access_groups">
            <label for="id_access_groups">{{ transForm.access_groups.label }}{% tooltiplink "ctxt-help-transcription-access_groups" %}</label>
            {{ transForm.access_groups }}
			<div id="ctxt-help-transcription-access_groups" style="display:none">
				<h6>Groupes d'accès</h6>
				<p>Seuls les membre des groupes sélectionnés pourront voir cette transcription.</p>
				<p>Maintenez appuyé &laquo;&nbsp;Ctrl&nbsp;&raquo;, ou &laquo;&nbsp;Commande (touche 
					pomme)&nbsp;&raquo; sur un Mac, pour en sélectionner plusieurs ou en désélectionner.</p>
			</div>
        </div>
        <div class="fixclear"></div>
        
        <div class="fieldWrapper access_users radio_field">
            <label for="id_access_users">Accès Utilisateurs{% tooltiplink "ctxt-help-transcription-access_users" %}</label>
            <input type="checkbox" name="access_users" id="id_access_users" 
            	   {% if not transcription.access_public and not transcription.access_private and not transcription.access_groups.all.exists %}checked="checked"{% endif %}>
			<div id="ctxt-help-transcription-access_users" style="display:none">
				<h6>Accès utilisateurs</h6>
				<p>Seuls les utilisateurs identifiés pourront voir cette transcription.</p>
			</div>
        </div>
        <div class="fixclear"></div>

        <div class="fieldWrapper access_public radio_field">
            {% if perms.fiches.publish_transcription %}
            {{ transForm.access_public.errors }}
            <label for="id_access_public">Accès Public{% tooltiplink "ctxt-help-transcription-access_public" %}</label>
            {{ transForm.access_public }}
			<div id="ctxt-help-transcription-access_public" style="display:none">
				<h6>Accès public</h6>
				<p>Tout le monde pourra voir cette transcription.</p>
			</div>            
            {% else %}
            <label class="inner-label" for="id_access_public">
            <input type="checkbox" disabled="disabled" id="id_access_public" name="access_public" {{ transForm.instance.access_public|yesno:"checked='checked'," }}>
            Public</label>
            {% endif %}
        </div>
        <div class="fixclear"></div>
        
        <script>
        	$(function () {
        		$('.access :checkbox').click(function() {
        			$('.access :checkbox').prop("checked", false);
        			$('.access select').prop("selectedIndex", -1);
        			this.checked = true;
        		});
        		$('.access select').change(function() {
        			if ( this.selectedIndex >= 0 ) {
            			$('.access :checkbox').prop("checked", false);
        			} else {
            			$('.access #id_access_private').prop("checked", true);
        			}
        		});
                {# // handle collapsible fieldset #}
           		$(".collapse_btn")
           		    .append(function () {
           		    	var icon = 'ui-icon-triangle-1-n'; 
           		    	if ( $(this).parents('fieldset').hasClass('collapsed') ) {
           		    		icon = 'ui-icon-triangle-1-s';
           		    	}
           		    	return '<span class="ui-icon ' + icon + '"></span>';
           		    })
           		    .addClass("ui-state-default")
           		    .hover(
           			     function(){ $(this).removeClass("ui-state-default").addClass("ui-state-hover"); }, 
           				 function(){ $(this).removeClass("ui-state-hover").addClass("ui-state-default"); }
           			)
           			.click(function(){
           				var $this = $(this);
           				$this.find(".ui-icon").toggleClass("ui-icon-triangle-1-s ui-icon-triangle-1-n");
           				$this.parents('fieldset').toggleClass('collapsed').children('.fieldWrapper').toggle();
           			});
           		$('fieldset.collapsed').children('.fieldWrapper').toggle();
        	});
        </script>
    </fieldset>
	

    {#<!-- ========== NOTES ========== -->#}
	<fieldset>
		<div class="legend">Notes</div>
		{% with "TRANSCRIPTION" as tinymce_config_name %}{% include "fiches/edition/note_formset.html" %}{% endwith %}
	</fieldset>
	</form>
	</div>
	
	<!-- Right column: Facsimile Viewer -->
	<div class="facsimile-viewer-panel" id="facsimile-viewer-panel">
		<div class="facsimile-controls">
			<h3>Facsimilé</h3>
			<button id="facsimile-zoom-in" type="button">Zoom +</button>
			<button id="facsimile-zoom-out" type="button">Zoom -</button>
			<button id="facsimile-home" type="button">Réinitialiser</button>
			<button id="facsimile-full-page" type="button">Plein écran</button>
		</div>
		<div id="facsimile-viewer"></div>
	</div>
</div>
<script type="text/javascript">
// Synchronise CKEditor avec le textarea avant validation
(function($){
	$(document).ready(function(){
		$("form.edit-form.transcription").on('submit', function(e) {
			if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances['id_text']) {
				CKEDITOR.instances['id_text'].updateElement();
			}
			// Validation blocking popup for required fields
			var requiredFields = [
				'#id_text' // Ajoutez d'autres champs requis si nécessaire
			];
			var missing = [];
			requiredFields.forEach(function(sel) {
				var $f = $(sel);
				if ($f.length && !$f.val().trim()) {
					var label = $("label[for='"+$f.attr('id')+"']").text() || sel;
					missing.push(label);
				}
			});
			if (missing.length > 0) {
				alert('Please fill in the following required fields before saving:\n' + missing.join('\n'));
				e.preventDefault();
			}
		});

		// Handle facsimile URL validation and toggle load/unload
		var facsimileViewer = null;
		$('#validate-facsimile-url').click(function() {
			var $btn = $(this);
			var loaded = $btn.data('loaded') === true;
			// If already loaded, act as "Supprimer" (unload)
			if (loaded) {
				unloadFacsimileViewer();
				$btn.data('loaded', false).text('Charger');
				$('#id_facsimile_iiif_url').prop('disabled', false);
				return;
			}
			// Otherwise, try to validate and load
			var url = $('#id_facsimile_iiif_url').val().trim();
			if (!url) {
				alert('Veuillez d\'abord saisir une URL de manifeste IIIF.');
				return;
			}
			// Show loading
			$btn.prop('disabled', true).text('Chargement...');
			
			$.ajax({
				url: url,
				dataType: 'json',
				timeout: 10000,
				success: function(data) {
					// valid manifest / info.json
					loadFacsimileViewer(url);
					$btn.data('loaded', true).text('Supprimer');
					// disable input to prevent edits and add hidden field to submit value
					$('#id_facsimile_iiif_url').prop('disabled', true);
					$('<input type="hidden" name="facsimile_iiif_url" value="' + url + '">').insertAfter('#id_facsimile_iiif_url');
				},
				error: function(xhr, status, error) {
					var msg = '✗ URL de manifeste IIIF invalide.\n';
					if (status === 'timeout') {
						msg += 'Délai d\'attente dépassé.';
					} else if (xhr.status === 0) {
						msg += 'Erreur réseau - URL non accessible.';
					} else {
						msg += 'HTTP ' + xhr.status + ': ' + error;
					}
					alert(msg);
				},
				complete: function() {
					$btn.prop('disabled', false);
					// if not marked loaded, ensure text is Charger
					if ($btn.data('loaded') !== true) {
						$btn.text('Charger');
					}
				}
			});
		});
		
		// Function to unload facsimile viewer and clear state
		function unloadFacsimileViewer() {
			if (facsimileViewer && typeof facsimileViewer.destroy === 'function') {
				try {
					facsimileViewer.destroy();
				} catch (e) {
					console.warn('Error destroying facsimile viewer', e);
				}
				facsimileViewer = null;
			}
			// clear viewer container and hide panel
			var viewerDiv = document.getElementById('facsimile-viewer');
			if (viewerDiv) viewerDiv.innerHTML = '';
			$('#facsimile-viewer-panel').removeClass('visible');
			// clear input value, remove hidden field, enable input
			$('#id_facsimile_iiif_url').val('');
			$('input[type="hidden"][name="facsimile_iiif_url"]').remove();
			$('#id_facsimile_iiif_url').prop('disabled', false);
		}
		
		// Function to load facsimile viewer
		function loadFacsimileViewer(iiifUrl) {
			// Show the viewer panel
			$('#facsimile-viewer-panel').addClass('visible');
			
			// Check if it's a manifest URL or direct image info.json
			if (iiifUrl.includes('manifest')) {
				// Fetch the manifest and extract images
				fetch(iiifUrl)
					.then(function(response) {
						if (!response.ok) {
							throw new Error('HTTP error! status: ' + response.status);
						}
						return response.json();
					})
					.then(function(manifest) {
						var tileSources = [];
						
						// IIIF Presentation API v3 (items)
						if (manifest.items && manifest.items.length > 0) {
							manifest.items.forEach(function(canvas) {
								if (canvas.items && canvas.items[0] && canvas.items[0].items) {
									var annotation = canvas.items[0].items[0];
									if (annotation.body) {
										var body = annotation.body;
										// Get service URL from service array
										if (body.service && body.service.length > 0) {
											var serviceId = body.service[0]['@id'] || body.service[0].id;
											if (serviceId) {
												tileSources.push(serviceId + '/info.json');
											}
										}
									}
								}
							});
						}
						// IIIF Presentation API v2 (sequences)
						else if (manifest.sequences && manifest.sequences[0]) {
							var canvases = manifest.sequences[0].canvases || [];
							canvases.forEach(function(canvas) {
								if (canvas.images && canvas.images[0]) {
									var resource = canvas.images[0].resource;
									if (resource.service) {
										var serviceId = resource.service['@id'] || resource.service.id;
										if (serviceId) {
											tileSources.push(serviceId + '/info.json');
										}
									}
								}
							});
						}
						
						if (tileSources.length > 0) {
							initFacsimileViewer(tileSources);
						} else {
							showFacsimileError('Erreur: Impossible d\'extraire les images du manifeste IIIF');
						}
					})
					.catch(function(error) {
						console.error('Failed to load manifest:', error);
						showFacsimileError('Erreur: Impossible de charger le manifeste IIIF<br><small>' + error.message + '</small>');
					});
			} else {
				// Direct image info.json URL
				initFacsimileViewer([iiifUrl]);
			}
		}
		
		function showFacsimileError(message) {
			var viewerDiv = document.getElementById('facsimile-viewer');
			if (viewerDiv) {
				viewerDiv.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">' + message + '</div>';
			}
		}
		
		function initFacsimileViewer(tileSources) {
			// destroy existing viewer if any
			if (facsimileViewer && typeof facsimileViewer.destroy === 'function') {
				try { facsimileViewer.destroy(); } catch (e) { console.warn(e); }
			}
			facsimileViewer = OpenSeadragon({
				id: "facsimile-viewer",
				prefixUrl: "{% static 'js/lib/openseadragon/images/' %}",
				tileSources: tileSources,
				sequenceMode: tileSources.length > 1,
				showNavigationControl: true,
				navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_RIGHT,
				zoomInButton: "facsimile-zoom-in",
				zoomOutButton: "facsimile-zoom-out",
				homeButton: "facsimile-home",
				fullPageButton: "facsimile-full-page",
				showNavigator: true,
				navigatorPosition: "BOTTOM_RIGHT",
				navigatorHeight: "120px",
				navigatorWidth: "150px",
				showReferenceStrip: tileSources.length > 1,
				referenceStripScroll: 'horizontal'
			});
		}
	});
})(jQuery);
</script>
{% endblock main_content %}
