{% comment %}<!--
   Copyright (C) 2010-2012 Université de Lausanne, RISET
   < http://www.unil.ch/riset/ >

   This file is part of Lumières.Lausanne.
   Lumières.Lausanne is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   Lumières.Lausanne is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

   This copyright notice MUST APPEAR in all copies of the file.
-->{% endcomment %}
{% comment %}<!--
===========================================================
==    Relation Formset
===========================================================
-->{% endcomment %}
{% load i18n %}
{{ relationFormset.management_form }}
<div class="formset relation-formset">
    <div class="form-header">
		<div class="field">Personne</div>
    <div class="field"></div>
		<div class="field">Type de relation</div>
		{% if relationFormset.can_delete %}<div class="field delete-field">Supprimer</div>{% endif %}
    </div>
    {% for rel_form in relationFormset.forms %}
    <div class="form-instance relation-form{% if rel_form.errors %} error-in-form{% endif %}">
    	{{ rel_form.id }}
        <div class="field related-person">{{ rel_form.related_person.errors }}
        	{{ rel_form.related_person }}
        </div>
        <div>est son/sa</div>
        <div class="field relationtype">{{ rel_form.relation_type.errors }}
        	{{ rel_form.relation_type }}
        </div>
       {% if relationFormset.can_delete and rel_form.instance.id %}<div class="field delete-field">{{ rel_form.DELETE }}</div>{% endif %}
       {% if not rel_form.instance.id %}<div class="field delete-field"><input type="checkbox" name="extra_form_DELETE" class="formset_delete_but"></div>{% endif %}
	</div>
    {% endfor %}
	<div id="relation-empty_form" class="empty_form" style="display:none">
	    <div class="form-instance relation-form">
	        {{ relationFormset.empty_form.id }}
	        <div class="field related-person">
	            {{ relationFormset.empty_form.related_person }}
	        </div>
          <div>est son/sa</div>
	        <div class="field relationtype">
	            {{ relationFormset.empty_form.relation_type }}
	        </div>
	       <div class="field delete-field"><input type="checkbox" name="extra_form_DELETE" class="formset_delete_but"></div>
	    </div>
	</div>
</div>

<div class="formset-new-field-bar" id="relation-formset-new-field-bar">
    <button type="button" class="formset-add-new-field" id="id_but_relation_add_field">Ajouter des champs</button>
</div>

{% if reverse_relations %}
<ul class="relations-list relations-reverse">{% spaceless %}
{% for r in reverse_relations %}{% with r.bio.person as related_person %}
  <li>
  {% if related_person.has_biography and r.bio.valid or not r.bio.valid and perms.fiches.access_unvalidated_biography %}
    {{ r.relation_type.reverse_name }}: <a href="{% url 'biography-display' related_person.id %}">{{ related_person }}</a>
  {% else %}
    {{ r.relation_type.reverse_name }}: <span>{{ related_person }}</span>
  {% endif %}
  {% if not r.bio.valid %}<div class="invalid-bio-marker" title="{% trans "Relation définie dans une biographie pas encore validée" %}"></div>{% endif %}
  </li>{% endwith %}
{% endfor %}
{% endspaceless %}</ul>
{% endif %}

<script type="text/javascript">
(function($){
    var init_when_doc_ready = false;
    var canAddPerson = {% if can_add_person %}true{% else %}false{% endif %};
    var addPersonUrl = "{% url 'biography-ajax-add-person' %}";

    function __init__() {
    $(".Relation_related_person:visible, .ContributionDoc_person:visible").each(function(){ bindRelatedPersonAutocomplete(this) });

        var rel_formset = $(".relation-formset");
		// addRemoveFormBut
		rel_formset.find(".relation-form").not(".empty_form .relation-form").each(function(){
			fiches_edit.addRemoveFormBut(this, "Supprimer la relation", updateNewFieldBarWidth);
		});
		rel_formset.find(".form-header .delete-field").text(" ");
		rel_formset.find(".form-instance .delete-field").css({paddingLeft: 0, paddingRight: 0});


        // Add field button
        $("#relation-formset-new-field-bar")
          .width(rel_formset.width())
          .css({textAlign: "right"});
        $("#id_but_relation_add_field").bind('click', add_relation_field);
        fiches_edit.applyAddFieldButtonUI( $("#id_but_relation_add_field") );


		$(".error-in-form .disabled_lookup").removeAttr("disabled");
		$(".formset .error-in-form")
		    .find(".field").css({borderWidth:"1px 0"}).end()
		    .find(".field:first").css({borderLeftWidth:"1px"}).end()
		    .find(".field:last").css({borderRightWidth:"1px"}).end();
   };
    if (init_when_doc_ready) { $(document).ready(function(){__init__();}); }
    else { __init__(); }


	var updateNewFieldBarWidth = function() {
		if ($(".form-instance:animated").length) {
		  setTimeout(updateNewFieldBarWidth, 50);
		} else {
		  $("#relation-formset-new-field-bar").width($(".relation-formset").width());
		}
	}

    function add_relation_field() {
        var emptyFormHtml = $("#relation-empty_form").html(),
            newIdx = parseInt($("#id_relation_set-TOTAL_FORMS").val()),
            newFormHtml = emptyFormHtml.replace(/__prefix__/g, newIdx),
            newForm = $(newFormHtml);
        $("#id_relation_set-TOTAL_FORMS").val(newIdx + 1);

        // Fix field names for text and hidden inputs
        newForm.find('input[type="text"]').each(function() {
            var name = $(this).attr('name');
            if (!name.startsWith('lookup_relation_set-')) {
                // Try to fix the name if needed
                var base = name.replace(/^lookup_/, '');
                $(this).attr('name', 'lookup_' + base);
            }
        });
        newForm.find('input[type="hidden"]').each(function() {
            var name = $(this).attr('name');
            if (!name.startsWith('relation_set-')) {
                // Try to fix the name if needed
                var base = name.replace(/^lookup_/, '');
                $(this).attr('name', base);
            }
        });

        $(".relation-form").not("#relation-empty_form .relation-form").last().after(newForm);
    $(".Relation_related_person:visible, .ContributionDoc_person:visible", newForm).each(function(){ bindRelatedPersonAutocomplete(this) });

        fiches_edit.addRemoveFormBut(newForm, "Supprimer la relation", updateNewFieldBarWidth);
    }

    function updateNewFieldBarWidth() {

    }


    function bindRelatedPersonAutocomplete(o) {
   	    $(o).autocomplete("{% url 'ajax-search' %}", {
				extraParams: {
					search_field: "name",
			        app_label: "fiches",
			        model_name: "Person",
	                outf: "_m__format_for_ajax_search",
			        and_queries: '[{"field":"==modern","value":false}]',
			        not_queries: '[{"field":"==id","value":{{ person_id }}}]'
			    },
	            formatResult: function (data, label) {
	            	// {# removes the birth/death dates if any from the submitted value #}
	            	if ( label.match(/\d+]$/) ) {
	            		return label.substring(0, label.lastIndexOf(' ['));
	            	} else {
	            		return label;
	            	}
	            }
   	        })

			.result(function(event, data, formatted) {
                var $t = $(this);
                var n = $t.attr('name');
                var target = $("[name='" + n.substr("lookup_".length) + "']");
                if (data) {
                    // data[1] = id, data[0] = label
                    target.val(data[1]); // Only the ID goes into the hidden field
                } else {
                    // Si pas de sélection, on refuse la saisie libre
                    target.val("");
                    $t.val("");
                }
            })

            .blur(function(){ $(this).search(); })

            .change(function(){
                var $t = $(this),
                    v = $.trim($t.val()),
                    n = $t.attr('name'),
                    target = $("[name='"+n.substr("lookup_".length)+"']");
                if (!v) {
                  target.val("");
                  return;
                }
                if (!target.val()) {
                    if (canAddPerson) {
                        createRelatedPerson(v, function(person){
                            target.val(person.id);
                            $t.val(person.name);
                        });
                    } else {
                        target.val("");
                    }
                }
            })

            .change();
   }


   function getCSRFToken() {
       var tokenField = $("form.edit-form input[name='csrfmiddlewaretoken']").first();
       return tokenField.val();
   }

   function createRelatedPerson(name, callback) {
       if (!canAddPerson || !addPersonUrl) { return; }
       var trimmed = $.trim(name || "");
       if (!trimmed) { return; }
       $.ajax({
           url: addPersonUrl,
           type: "POST",
           data: { name: trimmed },
           headers: { "X-CSRFToken": getCSRFToken() }
       }).done(function(resp){
           if (resp && (resp.success || resp.id)) {
               var payload = {
                   id: resp.id,
                   name: resp.name || trimmed
               };
               if (typeof callback === "function") {
                   callback(payload);
               }
           } else if (resp && resp.error) {
               alert(resp.error);
           }
       }).fail(function(xhr){
           var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : "Impossible d'enregistrer la nouvelle personne.";
           alert(msg);
       });
   }


   function isModernAuthors() {
       return '[{"field":"==modern","value":###}]'.replace('###', false);
   }




})(jQuery);
</script>
